name: CI/CD Pipeline

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write
  checks: write

jobs:
  # Step 1: Build and Test
  build-test:
    name: Build & Test
    uses: ./.github/workflows/build-test.yml
    with:
      java-version: '21'
      gradle-tasks: 'clean build test'

  # Step 2: Semantic Versioning
  version:
    name: Semantic Versioning
    needs: [build-test]
    uses: ./.github/workflows/version.yml
    with:
      java-version: '21'
      git-author-name: 'GitHub Actions CI'
      git-author-email: 'ci@cubizor.net'
    secrets:
      RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  # Debug: Check version outputs
  debug-version:
    name: Debug Version Outputs
    needs: [version]
    runs-on: arc-runner-set
    steps:
      - name: Print version outputs
        run: |
          echo "üîç Version Job Outputs:"
          echo "new-release-published = ${{ needs.version.outputs.new-release-published }}"
          echo "new-release-version = ${{ needs.version.outputs.new-release-version }}"
          echo "Condition will be: ${{ needs.version.outputs.new-release-published == 'true' }}"

  # Step 3 & 4: Build Versioned JAR and Publish to Nexus
  publish:
    name: Build & Publish
    needs: [version]
    if: needs.version.outputs.new-release-published == 'true'
    uses: ./.github/workflows/publish.yml
    with:
      java-version: '21'
      publish-task: 'publish'
    secrets:
      NEXUS_RELEASE_URL: ${{ secrets.NEXUS_RELEASE_URL }}
      NEXUS_SNAPSHOT_URL: ${{ secrets.NEXUS_SNAPSHOT_URL }}
      NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}